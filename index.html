<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>胰島素補打計算</title>
<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0; padding: 10px;
  background: #f0f2f5; color: #333;
}
h1 { text-align: center; margin-bottom: 20px; color: #0275d8; }
.section {
  background: #fff;
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 20px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
h2 { margin-top: 0; color: #555; }
label { display: block; margin-top: 12px; font-weight: bold; }
input, select { width: 100%; padding: 10px; margin-top: 5px; font-size: 1rem; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; }
button { margin-top: 15px; padding: 12px; width: 100%; font-size: 1rem; border-radius: 6px; border: none; background: #0275d8; color: #fff; cursor: pointer; transition: 0.3s; }
button:hover { background: #025aa5; }
.result { margin-top: 15px; font-weight: bold; font-size: 1.2rem; color: #d9534f; }
.tip { font-size: 0.9rem; color: #555; margin-top: 5px; }
.toast {
  visibility: hidden; min-width: 200px;
  background-color: rgba(0,0,0,0.8); color: #fff;
  text-align: center; border-radius: 6px; padding: 12px;
  position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%);
  font-size: 1rem;
}
.toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2s; }
@keyframes fadein { from {bottom: 20px; opacity: 0;} to {bottom: 30px; opacity:1;} }
@keyframes fadeout { from {bottom: 30px; opacity:1;} to {bottom: 20px; opacity:0;} }
</style>
</head>
<body>

<h1>胰島素補打計算</h1>

<!-- Toast -->
<div id="toast" class="toast">數值已更新</div>

<!-- 第一部分 -->
<div class="section" style="border-left:5px solid #0275d8;">
<h2>一、總胰島素與法則</h2>
<p class="tip">ISF：每單位胰島素可降低血糖；ICR：每單位胰島素可處理多少克碳水。</p>
<label>法則選擇：
<select id="ruleSelect">
  <option value="1800/500">速效 (1800 / 500)</option>
  <option value="1500/450">短效 (1500 / 450)</option>
</select>
</label>
<label>每日總胰島素 (TDD)：<input type="number" id="tdd" min="1" placeholder="輸入每日總劑量"></label>
<button onclick="calculateFactors()">計算 ISF 和 ICR</button>
</div>

<!-- 第二部分 -->
<div class="section" style="border-left:5px solid #5cb85c;">
<h2>二、確認或修改 ISF / ICR</h2>
<p class="tip">第一部分計算結果已帶入，可修改後按「確認」。</p>
<label>ISF：<input type="number" id="isfInput"></label>
<label>ICR：<input type="number" id="icrInput"></label>
<button onclick="updateFactors()">確認</button>
</div>

<!-- 第三部分 -->
<div class="section" style="border-left:5px solid #f0ad4e;">
<h2>三、補打速效胰島素</h2>
<p class="tip">輸入血糖與碳水量，系統將自動計算補打劑量。</p>
<label>目前血糖：<input type="number" id="currentBg"></label>
<label>目標血糖：<input type="number" id="targetBg" value="100"></label>
<label>餐點碳水量 (g)：<input type="number" id="carbs"></label>
<div class="result" id="doseResult">
  修正劑量：-- U<br>
  餐點劑量：-- U<br>
  補打總劑量：-- U
</div>
</div>

<script>
let isf = null;
let icr = null;

// 第一部分計算
function calculateFactors() {
  const tdd = parseFloat(document.getElementById("tdd").value);
  const rule = document.getElementById("ruleSelect").value;
  if(!tdd || tdd <= 0){ alert("請輸入有效 TDD"); return; }
  if(rule === "1800/500"){ isf = Math.floor(1800/tdd); icr = Math.floor(500/tdd); }
  else{ isf = Math.floor(1500/tdd); icr = Math.floor(450/tdd); }
  document.getElementById("isfInput").value = isf;
  document.getElementById("icrInput").value = icr;
  updateDose();
}

// 第二部分確認
function updateFactors() {
  const valISF = parseFloat(document.getElementById("isfInput").value);
  const valICR = parseFloat(document.getElementById("icrInput").value);
  if(!valISF || !valICR){ alert("請輸入有效數值"); return; }
  isf = valISF; icr = valICR;
  showToast("ISF / ICR 已更新");
  updateDose();
}

// Toast 顯示
function showToast(msg){
  const toast = document.getElementById("toast");
  toast.textContent = msg;
  toast.className = "toast show";
  setTimeout(()=>{toast.className = toast.className.replace("show","");}, 2500);
}

// 第三部分自動計算
function updateDose(){
  const current = parseFloat(document.getElementById("currentBg").value);
  const target = parseFloat(document.getElementById("targetBg").value);
  const carbs = parseFloat(document.getElementById("carbs").value);
  
  if(!isf || !icr || !current || !target){ 
    document.getElementById("doseResult").innerHTML = 
      "修正劑量：-- U<br>餐點劑量：-- U<br>補打總劑量：-- U"; 
    return;
  }

  // 血糖安全檢查
  if(current < 70){
    document.getElementById("doseResult").innerHTML = 
      "⚠ 低血糖危險！請立即補充15克糖，切勿補打胰島素！";
    return;
  }

  let correction = 0;
  let meal = carbs ? carbs/icr : 0;
  let total = 0;

  if(current < 100){
    document.getElementById("doseResult").innerHTML = 
      `⚠ 目前血糖 < 100，不建議補打胰島素，請依照進食量調整劑量！<br>
       餐點劑量：${meal.toFixed(1)} U`;
    return;
  }

  // 正常計算補打劑量
  correction = (current-target)/isf;
  total = Math.floor(correction + meal);

  document.getElementById("doseResult").innerHTML = 
    `修正劑量：${correction.toFixed(1)} U<br>
     餐點劑量：${meal.toFixed(1)} U<br>
     補打總劑量：${total} U`;
}

// 監控第三部分輸入
["currentBg","targetBg","carbs"].forEach(id=>{
  document.getElementById(id).addEventListener("input", updateDose);
});
</script>
</body>
</html>
